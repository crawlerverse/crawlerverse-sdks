name: Python SDK Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g. 0.2.0) â€” must match version in pyproject.toml'
        required: true
        type: string
      dry_run:
        description: 'Dry run (skip PyPI publish and tag creation)'
        required: false
        type: boolean
        default: false

defaults:
  run:
    working-directory: python

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify version matches pyproject.toml
        run: |
          TOML_VERSION=$(grep -m1 '^version' pyproject.toml | sed 's/.*"\(.*\)"/\1/')
          if [ "$TOML_VERSION" != "${{ inputs.version }}" ]; then
            echo "::error::Version mismatch: input=${{ inputs.version }}, pyproject.toml=$TOML_VERSION"
            echo "Update pyproject.toml version to ${{ inputs.version }} before releasing."
            exit 1
          fi
          echo "Version $TOML_VERSION confirmed."

      - name: Check tag does not already exist
        run: |
          if git rev-parse "python-sdk-v${{ inputs.version }}" >/dev/null 2>&1; then
            echo "::error::Tag python-sdk-v${{ inputs.version }} already exists."
            exit 1
          fi

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: [validate]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync --group dev

      - name: Lint
        run: uv run ruff check src/ tests/

  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: [validate]
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13']
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: Install dependencies
        run: uv sync --group dev

      - name: Run tests
        run: uv run pytest -v --tb=short --cov=crawlerverse --cov-report=term-missing

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [lint, test]
    environment: pypi
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install 3.13

      - name: Build package
        run: uv build

      - name: Verify package
        run: |
          uv run python -c "
          from crawlerverse import __version__
          assert __version__ == '${{ inputs.version }}', f'Package version {__version__} != ${{ inputs.version }}'
          print(f'crawlerverse {__version__} built OK')
          "

      - name: Create git tag
        if: ${{ !inputs.dry_run }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "python-sdk-v${{ inputs.version }}" -m "Release Python SDK v${{ inputs.version }}"
          git push origin "python-sdk-v${{ inputs.version }}"

      - name: Publish to PyPI
        if: ${{ !inputs.dry_run }}
        run: uv publish
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_API_TOKEN }}

      - name: Create GitHub Release
        if: ${{ !inputs.dry_run }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: python-sdk-v${{ inputs.version }}
          name: Python SDK v${{ inputs.version }}
          generate_release_notes: true
          files: python/dist/*

      - name: Dry run summary
        if: ${{ inputs.dry_run }}
        run: |
          echo "## Dry run complete" >> $GITHUB_STEP_SUMMARY
          echo "Would have:" >> $GITHUB_STEP_SUMMARY
          echo "- Created tag: python-sdk-v${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- Published to PyPI" >> $GITHUB_STEP_SUMMARY
          echo "- Created GitHub Release with dist artifacts" >> $GITHUB_STEP_SUMMARY
